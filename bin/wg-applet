#!/usr/bin/python3
import os
import psutil
import time
import sys
import notify2
from PyQt5 import QtCore, QtGui, QtWidgets
from functools import partial
import WGapplet


DEBUG = False
LOG = False
IMG_PATH = WGapplet.get_img_path()
print(IMG_PATH)
TRAY_TOOLTIP = 'Wireguard applet'
TRAY_ICON_CONNECTED = os.path.join(IMG_PATH,'vpn-on.png')
TRAY_ICON_NOTCONNECTED = os.path.join(IMG_PATH,'vpn-off.png')

TUN_PATH = '/sys/class/net/'
# TUN_NAME = 'false'

WG_CONF_PATH = '/etc/wireguard'

CONFS = os.listdir(WG_CONF_PATH)
CONFS = [x.split(".")[0] for x in CONFS]

state = {'RUNNING':0,'NOTRUNNING':1}


def log(msg,type='info'):
    output = ''
    if type == 'info':
        output += '[INFO]'
    elif type == 'error':
        output += '[ERROR]'
    elif DEBUG and type == 'debug':
        output += '[DEBUG]'
    output +='Wireguard-applet: ' + msg
    
    if LOG == True:
        print(output)

def dlog(msg):
    log(msg,type='debug')


class Worker(QtCore.QRunnable):

    def run(self):
        dlog("main loop start")
        time.sleep(1)
        dlog("main loop end")

class SystemTrayIcon(QtWidgets.QSystemTrayIcon):

    def __init__(self, icon, parent=None):
        # self.wg_confs = os.listdir(WG_CONF_PATH)
        # self.wg_confs = [x.split(".")[0] for x in self.wg_confs]
        # for wg_conf in wg_confs:
        #     print(wg_conf)


        QtWidgets.QSystemTrayIcon.__init__(self, icon, parent)
        self.menu = QtWidgets.QMenu(parent)

        self.exitAction = self.menu.addAction("Exit")
        self.exitAction.triggered.connect(self.exit)


        self.vpn_menu = self.menu.addMenu('VPNs')

        for wg_conf in CONFS:
            # wg_action = self.vpn_menu.addAction(wg_conf,checkable=True)
            self.vpn_menu.addAction(QtWidgets.QAction(wg_conf, self.vpn_menu, checkable=True, triggered = partial(self.toogle_VPN,wg_conf)))
            # wg_action.triggered.connect(self.toogle_VPN)

        self.setContextMenu(self.menu)
        
        # Thread work 
        self.timer = QtCore.QTimer()
        self.timer.setInterval(5000)
        self.timer.timeout.connect(self.work)
        self.timer.start()

        self.vpn_connected = SystemTrayIcon.check_vpn_connected()
        try:
            notify2.init("Wireguard init")
            self.notif = True
        except:
            self.notif = False
            pass

    def changeIcon(self,icon):
        self.setIcon(QtGui.QIcon(TRAY_ICON_CONNECTED))

    def toogle_VPN(self,wg_name):
        # global TUN_NAME
        print("Toogel VPN",wg_name)
        #todo:
        # 1) deactivate the possibility for choosing vpn
        # 2) add a statusfield to menu like connected to vpn_name
        # 3) add deactivate button

        if not self.check_vpn_connected():
            # 4) run wg-quick with the config
            os.system("wg-quick up "+wg_name)
        else:
            # 4) run wg-quick with the config
            os.system("wg-quick down "+wg_name)

    def run(self):
        dlog("SystemTrayIcon started")
        return

    def exit(self):
        QtCore.QCoreApplication.exit()

    def work(self):
        # check vpn connection
        # change icon accordingly
        # popup on connection
        # popup on disconnect

        new_state = SystemTrayIcon.check_vpn_connected()
        
        if not self.vpn_connected and new_state:
            self.setIcon(QtGui.QIcon(TRAY_ICON_CONNECTED))
            self.vpn_connected = new_state
            if self.notif:
                n = notify2.Notification("Wireguard VPN Connected")
                # Set the urgency level
                n.set_urgency(notify2.URGENCY_NORMAL)
                # Set the timeout
                n.set_timeout(1000)
                n.show()

        elif self.vpn_connected and not new_state:
            self.setIcon(QtGui.QIcon(TRAY_ICON_NOTCONNECTED))
            self.vpn_connected = new_state
            if self.notif:
                n = notify2.Notification("Wireguard VPN disconnected")
                # Set the urgency level
                n.set_urgency(notify2.URGENCY_NORMAL)
                # Set the timeout
                n.set_timeout(1000)
                n.show()
        dlog("wake up to work")
        return
    
    @staticmethod
    def check_vpn_connected():
        for CONF in CONFS:
            if os.path.isdir(TUN_PATH+CONF):
                # print("VPN connected: ",CONF)
                log('vpn connected: ',CONF)
                return True
        log('vpn not connected')
        return False


def parseargs():
    global LOG
    if len(sys.argv) == 1:
        return
    if sys.argv[1] == "-v":
        LOG = True
        log("log activated")

def launch_app():
    app = QtWidgets.QApplication(sys.argv)

    w = QtWidgets.QWidget()
    if SystemTrayIcon.check_vpn_connected():
        trayIcon = SystemTrayIcon(QtGui.QIcon(TRAY_ICON_CONNECTED), w)
    else:
        trayIcon = SystemTrayIcon(QtGui.QIcon(TRAY_ICON_NOTCONNECTED), w)

    trayIcon.show()
    trayIcon.run()
    sys.exit(app.exec_())


def main():
    parseargs()
    
    time.sleep(1)
    launch_app()

if __name__ == '__main__':
    main()
